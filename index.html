<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 128 128%27%3E%3Crect width=%27128%27 height=%27128%27 rx=%2724%27 fill=%27%231976d2%27/%3E%3Cpath d=%27M30 70h68v14H30zM30 44h40v14H30z%27 fill=%27%23fff%27/%3E%3C/svg%3E" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Mini Trello — Kanban + Matriz + Agenda (Sync)</title>
  <style>
    :root{--bg:#0f1a2a;--panel:#0f223d;--ink:#e9f1ff;--brand:#1976d2;--card:#112b4a;--muted:#9fb3d2;--accent:#2a71ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
    header.app{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:10px 12px;background:var(--brand);color:#fff;flex-wrap:wrap}
    header.app h1{margin:0;font-size:18px;font-weight:700}
    header.app .right{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    header.app input, header.app button, header.app select{border:none;border-radius:8px;padding:6px 10px}
    header.app button{background:#0e58a5;color:#fff;cursor:pointer}
    header.app .ghost{background:#0b437e}

    /* T deitado: Listas em cima, Matriz abaixo (mesma coluna), Agenda fixa na direita */
    .workspace{display:grid;grid-template-columns:1fr 240px;gap:12px;padding:12px;align-items:start}
    .left{display:flex;flex-direction:column;gap:12px;min-width:0}
    .board{display:flex;gap:12px;align-items:flex-start;overflow:auto}

    .list{background:var(--panel);border:1px solid #183453;border-radius:10px;display:flex;flex-direction:column;min-width:240px}
    .list header{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #19375b;background:#122b4a}
    .list header input.title{flex:1;border:none;border-radius:8px;padding:6px 8px;background:#0e2542;color:var(--ink)}
    .cards{display:flex;flex-direction:column;gap:6px;padding:8px;min-height:34px}

    .card{background:var(--card);border:1px solid #20486f;border-left:8px solid transparent;border-radius:8px;padding:8px;cursor:grab;user-select:none;position:relative}
    .card.selected{outline:2px solid #2a71ff; background:#0f2f57}
    .card .text{white-space:pre-wrap}
    .meta{margin-top:6px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .timer{margin-left:auto;font-weight:700;letter-spacing:.5px;}
    .timer.warn{color:#ffd166}
    .timer.danger{color:#ff8a8a}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #375b86}
    .kebab{position:absolute;top:2px;right:2px;background:transparent;border:1px solid transparent;color:#9fc1ff;border-radius:6px;padding:0 6px;line-height:20px;cursor:pointer}

    .add{padding:8px;border-top:1px solid #19375b}
    .add .row{display:flex;gap:6px}
    .add input[type=text]{flex:1;border:1px solid #2a4e78;border-radius:8px;padding:8px;background:#0b2240;color:var(--ink)}

    .matrix{display:grid;grid-template-columns:40px 1fr 1fr;grid-template-rows:40px auto auto;gap:12px;align-items:start}
    .axis{display:flex;align-items:center;justify-content:center;font-weight:700;color:#cfe0ff;background:#102b4f;border:1px solid #1a416a;border-radius:10px}
    .axis.corner{background:transparent;border:none}
    .axis.axis-y{writing-mode:vertical-rl;transform:rotate(180deg);display:flex;align-items:center;justify-content:center;padding:4px 0;font-weight:700;color:#cfe0ff;background:#102b4f;border:1px solid #1a416a;border-radius:10px}
    .quad-label{font-weight:700;color:#cfe0ff}
    .list[data-type="quad"]{min-width:unset}
    .list[data-type="quad"][data-quad="Q1"]{background:#0f2f2a;border-color:#1e5b4e}
    .list[data-type="quad"][data-quad="Q1"] header{background:#104239}
    .list[data-type="quad"][data-quad="Q2"]{background:#0f243a;border-color:#1b4e84}
    .list[data-type="quad"][data-quad="Q2"] header{background:#0e3155}
    .list[data-type="quad"][data-quad="Q3"]{background:#3a290f;border-color:#7c5a19}
    .list[data-type="quad"][data-quad="Q3"] header{background:#5a4014}
    .list[data-type="quad"][data-quad="Q4"]{background:#3a0f12;border-color:#7c1920}
    .list[data-type="quad"][data-quad="Q4"] header{background:#5a1419}

    .schedule{background:var(--panel);border:1px solid #183453;border-radius:12px;max-height:calc(100vh - 84px);overflow:auto;position:sticky;top:84px;min-width:240px;width:240px}
    .schedule header{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#0b437e;color:#fff;border-top-left-radius:12px;border-top-right-radius:12px}
    .schedule header input[type=date]{background:#0b2240;color:#fff;border:1px solid #2a4e78;border-radius:8px;padding:6px 8px}

    .slot{border-bottom:1px dashed #244b78}
    .slot>div.head{display:flex;align-items:center;gap:6px;padding:0 4px}
    .slot .time{font-weight:700;font-size:11px;color:#9fc1ff}
    .slot .cards{display:none;padding:4px;min-height:28px}
    .slot.has-items .cards{display:block}
    .slot.hover{background:#0e2446;box-shadow:inset 0 0 0 2px #1976d2}

    .placeholder{height:38px;border:2px dashed #1976d2;border-radius:8px;background:#0e2446}

    .ctx{position:fixed;background:#0b1220;color:#fff;border:1px solid #24314a;border-radius:8px;min-width:220px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;z-index:1000}
    .ctx button{display:block;width:100%;text-align:left;background:transparent;border:none;color:#dbe7ff;padding:10px 12px;border-radius:0}
    .ctx button:hover{background:#1a2842}
    .ctx .sep{height:1px;background:#23314a;margin:6px 0}
    .ctx-sub{position:absolute;left:100%;top:0;background:#0b1220;color:#fff;border:1px solid #24314a;border-radius:8px;min-width:240px;max-height:300px;overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,.3);display:none}

    /* Mantemos o mesmo layout também no Android (sem quebrar para coluna) */
    body.android .kebab{display:block}
    .list header .more{margin-left:auto;background:transparent;border:1px solid transparent;color:#9fc1ff;border-radius:6px;padding:0 6px;line-height:20px;cursor:pointer}

    /* Responsividade extra para dobráveis: encurta listas e agenda quando largura é limitada */
    @media (max-width: 900px) {
      .list{min-width:220px}
      .workspace{grid-template-columns:1fr 220px}
      .schedule{width:220px;min-width:220px}
    }
  </style>
</head>
<body>
  <header class="app">
    <h1>Mini Trello</h1>
    <button id="undo" title="Desfazer (Ctrl+Z)">⟲</button>
    <button id="redo" title="Refazer (Ctrl+Shift+Z)">⟳</button>
    <div class="right">
      <button id="filterColorsBtn" class="ghost" title="Filtrar por cor">Filtros de cor</button>
      <strong id="sumTimers" title="Tempo restante total">0:00</strong>
      <label>De <input id="fFrom" type="date" class="ghost" /></label>
      <label>Até <input id="fTo" type="date" class="ghost" /></label>
      <button id="clearFilters">Limpar filtros</button>
      <button id="androidToggle" class="ghost">Modo Android</button>
      <button id="addList">+ Lista</button>

      <!-- NOVOS BOTÕES DE SYNC MANUAL -->
      <button id="exportJson" title="Baixar backup JSON" class="ghost">Exportar JSON</button>
      <button id="importJsonBtn" title="Restaurar de JSON" class="ghost">Importar JSON</button>
      <input id="importFile" type="file" accept="application/json,.json" style="display:none" />

      <button id="reset">Resetar</button>
      <button id="wipeRoom" class="ghost" title="Apagar dados desta sala no servidor">Limpar sala</button>
      <button id="archivePrev" class="ghost" title="Arquivar mês anterior">Arquivar mês anterior</button>
    </div>
  </header>

  <section class="workspace">
    <div class="left">
      <main class="board" id="board"></main>
      <section class="matrix" id="matrix"></section>
    </div>
    <aside class="schedule" id="schedule">
      <header>
        <strong>AGENDA</strong>
        <div style="display:flex;align-items:center;gap:8px">
          <input id="agendaDate" type="date" />
          <button id="copyDay" title="Copiar agenda de outra data">Copiar</button>
        </div>
      </header>
      <div id="slots"></div>
    </aside>
  </section>

  <!-- Menu de cartão (Timer primeiro) -->
  <div id="ctx" class="ctx">
    <button data-action="timer">Timer…</button>
    <div class="sep"></div>
    <button data-action="dup">Duplicar</button>
    <button data-action="del">Excluir</button>
    <div id="ctx-move" style="position:relative">
      <button data-action="move">Mover para ▶</button>
      <div class="ctx-sub" id="ctx-move-sub"></div>
    </div>
    <div id="ctx-move-all" style="position:relative">
      <button data-action="move-all">Mover TODOS desta lista ▶</button>
      <div class="ctx-sub" id="ctx-moveall-sub"></div>
    </div>
    <button data-action="del-all">Excluir TODOS desta lista</button>
    <div class="sep"></div>
    <button data-action="color">Editar cor…</button>
    <button data-action="date">Editar data…</button>
  </div>
  
  <!-- Menu de lista (cabeçalho) -->
  <div id="ctx-list" class="ctx">
    <button data-action="list-del">Excluir lista</button>
    <button data-action="list-move-all">Mover todos para ▶</button>
    <div class="ctx-sub" id="ctx-list-move-sub"></div>
  </div>

  <script>
  (function(){
    // ===== Helpers =====
    const el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n};
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const to2=n=> (n<10?'0'+n:''+n);
    const LS_KEY='mini-trello-restore';
    let __persistTick=null; // evitar duplicidade
    let __muteHistory=0; // silencia pushHistory durante undo/redo/restores
    function withMute(fn){ __muteHistory++; try{ return fn(); } finally { __muteHistory--; } }

    const board=document.getElementById('board');
    const matrix=document.getElementById('matrix');
    const schedule=document.getElementById('schedule');
    const slotsRoot=document.getElementById('slots');
    const ctx=document.getElementById('ctx');
    const ctxMoveSub=document.getElementById('ctx-move-sub');
    const ctxMoveAllSub=document.getElementById('ctx-moveall-sub');
    const listCtx=document.getElementById('ctx-list');
    const listMoveSub=document.getElementById('ctx-list-move-sub');
    // filtro de cor (multi-seleção)
    const selectedColors = new Set();

    const getActiveDay=()=>{ const i=document.getElementById('agendaDate'); return i&&i.value?i.value:new Date().toISOString().slice(0,10); };
    const on=(id,ev,fn)=>{ const e=document.getElementById(id); if(e) e.addEventListener(ev,fn); };

    // ===== Persistência + Histórico =====
    function cardToData(c){return{ text:(c.querySelector('.text')?.textContent||'').trim(), color:c.dataset.color||'', due:c.dataset.due||'', when:c.dataset.when||'', timerEnd:c.dataset.timerEnd||'', timerLeft:c.dataset.timerLeft||'' }}
    function serialize(){ const data=[];
      $$('.list[data-type="kanban"]',board).forEach(l=> data.push({type:'kanban',title:l.querySelector('.title').value,cards:$$('.card',l).map(cardToData)}));
      $$('.list[data-type="quad"]',matrix).forEach(l=> data.push({type:'quad',quad:l.dataset.quad,cards:$$('.card',l).map(cardToData)}));
      $$('.list[data-type="time"]',schedule).forEach(s=> data.push({type:'time',time:s.dataset.time,cards:$$('.card',s).map(cardToData)}));
      return data; }
    function restore(arr){ board.innerHTML=''; ensureMatrix(); ensureSchedule(true);
      (arr||[]).forEach(x=>{
        if(x.type==='kanban'){ const l=createList(x.title); (x.cards||[]).forEach(cd=> l.querySelector('.cards').appendChild(createCard(cd))); }
        if(x.type==='quad'){ const cont=matrix.querySelector(`.list[data-quad="${x.quad}"] .cards`); (x.cards||[]).forEach(cd=> cont.appendChild(createCard(cd))); }
        if(x.type==='time'){ const cont=slotsRoot.querySelector(`.list[data-time="${x.time}"] .cards`); (x.cards||[]).forEach(cd=> cont.appendChild(createCard(cd))); }
      });
      applyFilters(); updateSlotsHasItems();
    }
    function persist(){
      if(__muteHistory>0) return; // não versiona durante replay
      clearTimeout(__persistTick);
      __persistTick=setTimeout(()=>{
        const snap=serialize();
        // Evita duplicar estado idêntico no topo do histórico
        const last = hist.length ? JSON.stringify(hist[hist.length-1]) : null;
        const cur  = JSON.stringify(snap);
        if(last!==cur) pushHistory(snap);
        try{ localStorage.setItem(LS_KEY, JSON.stringify(snap)); }catch(e){ console.error(e);} 
      },120);
    }

    let hist=[]; let cursor=-1; // histórico simples
    function pushHistory(snap){ hist=hist.slice(0,cursor+1); hist.push(snap); cursor=hist.length-1; updateUndoUi(); }
    function canUndo(){ return cursor>0; }
    function canRedo(){ return cursor>=0 && cursor<hist.length-1; }
    function updateUndoUi(){ const u=document.getElementById('undo'); const r=document.getElementById('redo'); if(u) u.disabled=!canUndo(); if(r) r.disabled=!canRedo(); }
    function doUndo(){ if(!canUndo()) return; clearTimeout(__persistTick); withMute(()=>{ cursor--; restore(hist[cursor]); }); updateUndoUi(); }
    function doRedo(){ if(!canRedo()) return; clearTimeout(__persistTick); withMute(()=>{ cursor++; restore(hist[cursor]); }); updateUndoUi(); }

    function load(){ try{const raw=localStorage.getItem(LS_KEY); if(raw){ const d=JSON.parse(raw); if(Array.isArray(d)&&d.length){ restore(d); pushHistory(d); return; } else if(d && Array.isArray(d.data)){ restore(d.data); pushHistory(d.data); return; } } }catch(e){console.error(e)} initDemo(); pushHistory(serialize()); }

    // ===== Cartões =====
    function paintCard(c){
      const color = c.dataset.color || '';
      if (color) {
        c.style.background = color; c.style.borderColor = color; c.style.borderLeftColor = color;
      } else {
        const def = getComputedStyle(document.documentElement).getPropertyValue('--card') || '#112b4a';
        c.style.background = def; c.style.borderColor = '#20486f'; c.style.borderLeftColor = 'transparent';
      }
      const dot = c.querySelector('.dot'); if (dot) dot.style.background = color || 'transparent';
      updateTimerBadge(c);
    }

    function createCard(data){
      const {text,color,due,when,timerEnd,timerLeft}=typeof data==='string'?{text:data}:data||{text:''};
      const c=el('div','card'); c.draggable=true; c.dataset.color=color||''; c.dataset.due=due||''; if(when) c.dataset.when=when; if(timerEnd) c.dataset.timerEnd=timerEnd; if(timerLeft) c.dataset.timerLeft=timerLeft;
      const t=el('span','text'); t.textContent=text||''; const meta=el('div','meta'); const dot=el('span','dot'); meta.append(dot);
      const kb=document.createElement('button'); kb.className='kebab'; kb.type='button'; kb.textContent='⋮'; kb.addEventListener('mousedown',ev=>ev.stopPropagation()); kb.addEventListener('click',ev=>{ ev.stopPropagation(); const r=kb.getBoundingClientRect(); showCtx(r.right,r.bottom,c); });
      c.append(t,meta,kb); paintCard(c);
      // seleção por clique
      c.addEventListener('mousedown',e=>{ if(e.button!==0) return; if(e.shiftKey){ rangeSelect(c); }
        else if(e.ctrlKey||e.metaKey){ toggleSelection(c); }
        else { clearSelection(); addSelection(c); }
      });
      c.addEventListener('dragstart',e=>{ e.stopPropagation(); const block = selected.has(c)? Array.from(selected) : [c]; pushPH(c); dragState={...dragState, leader:c, block}; try{e.dataTransfer.setData('text/plain','drag'); e.dataTransfer.effectAllowed='move';}catch(_){} });
      c.addEventListener('dragend',()=>{ cleanupPH(); persist(); updateSlotsHasItems(); });
      c.addEventListener('contextmenu',e=>{e.preventDefault(); if(!selected.has(c)) { clearSelection(); addSelection(c);} showCtx(e.clientX,e.clientY,c)});
      // Edição inline com duplo clique
      c.addEventListener('dblclick',(e)=>{ e.preventDefault(); startInlineEdit(c); });
      return c;
    }

    // ===== Edição inline =====
    function startInlineEdit(card){
      const tEl = card.querySelector('.text'); if(!tEl) return; if(card.classList.contains('editing')) return;
      card.classList.add('editing'); const original = tEl.textContent; tEl.setAttribute('contenteditable','true'); tEl.focus();
      const sel = window.getSelection(); const range = document.createRange(); range.selectNodeContents(tEl); range.collapse(false); sel.removeAllRanges(); sel.addRange(range);
      function finish(save){ tEl.removeEventListener('keydown',onKey); tEl.removeEventListener('blur',onBlur); tEl.removeAttribute('contenteditable'); card.classList.remove('editing'); if(!save){ tEl.textContent = original; } paintCard(card); persist(); }
      function onKey(ev){ if(ev.key==='Escape'){ ev.preventDefault(); finish(false); } if(ev.key==='Enter' && (ev.ctrlKey||ev.metaKey)) { ev.preventDefault(); finish(true); } }
      function onBlur(){ finish(true); }
      tEl.addEventListener('keydown', onKey); tEl.addEventListener('blur', onBlur);
    }

    // ===== DnD =====
    let dragState=null; let draggingList=null; let androidMode=false; const selected=new Set(); let lastAnchor=null;
    function clearSelection(){ selected.forEach(c=>c.classList.remove('selected')); selected.clear(); }
    function addSelection(c){ if(!selected.has(c)){ selected.add(c); c.classList.add('selected'); lastAnchor=c; }}
    function toggleSelection(c){ if(selected.has(c)){ selected.delete(c); c.classList.remove('selected'); } else { addSelection(c); }}
    function rangeSelect(to){ if(!lastAnchor){ addSelection(to); return; } const parent=lastAnchor.parentElement; if(to.parentElement!==parent){ addSelection(to); return; } const cards=[...parent.querySelectorAll('.card')]; const a=cards.indexOf(lastAnchor); const b=cards.indexOf(to); const [i,j]=a<b?[a,b]:[b,a]; clearSelection(); for(let k=i;k<=j;k++) addSelection(cards[k]); }
    function getSelectionOr(target){ return selected.size? Array.from(selected) : (target? [target] : []); }
    const pushPH=(leader)=>{ const ph=el('div','placeholder'); dragState={leader,block:[],placeholder:ph}; };
    const cleanupPH=()=>{ dragState?.placeholder?.remove(); dragState=null; };
    function nearestAfter(container,y){ const els=[...container.querySelectorAll('.card:not(.dragging)')]; return els.reduce((cl,child)=>{ const r=child.getBoundingClientRect(); const o=y-(r.top+r.height/2); return (o<0&&o>cl.offset)?{offset:o,element:child}:cl },{offset:-Infinity,element:null}).element; }

    function wireDropZone(cardsContainer){ const slotEl=cardsContainer.closest('.list');
      cardsContainer.addEventListener('dragover',e=>{ if(!dragState) return; e.preventDefault(); const after=nearestAfter(cardsContainer,e.clientY); const ph=dragState.placeholder; if(!after) cardsContainer.appendChild(ph); else cardsContainer.insertBefore(ph,after); });
      cardsContainer.addEventListener('drop',e=>{ if(!dragState) return; e.preventDefault(); const parent=dragState.placeholder.parentElement||cardsContainer; const ref=dragState.placeholder; const block = selected.size? Array.from(selected) : [dragState.leader]; block.forEach(n=> parent.insertBefore(n,ref)); applyWhen(slotEl, block); cleanupPH(); });
      if(slotEl && slotEl.dataset.type==='time'){
        slotEl.addEventListener('dragover',e=>{ if(!dragState) return; e.preventDefault(); slotEl.classList.add('hover'); const ph=dragState.placeholder; const after=nearestAfter(cardsContainer,e.clientY); if(!after) cardsContainer.appendChild(ph); else cardsContainer.insertBefore(ph,after); });
        slotEl.addEventListener('dragleave',()=> slotEl.classList.remove('hover'));
        slotEl.addEventListener('drop',e=>{ if(!dragState) return; e.preventDefault(); const parent=dragState.placeholder.parentElement||cardsContainer; const ref=dragState.placeholder; const block = selected.size? Array.from(selected) : [dragState.leader]; block.forEach(n=> parent.insertBefore(n,ref)); applyWhen(slotEl, block); slotEl.classList.remove('hover'); cleanupPH(); });
      }
    }
    function applyWhen(slotEl, nodes){ if(slotEl && slotEl.dataset.type==='time'){ const day=getActiveDay(); const time=slotEl.dataset.time; nodes.forEach(n=> n.dataset.when=`${day}T${time}`); slotEl.classList.add('has-items'); } else { nodes.forEach(n=> n.dataset.when=''); } updateSlotsHasItems(); persist(); }

    // mover listas (cabeçalho)
    board.addEventListener('dragover',e=>{ if(!draggingList) return; e.preventDefault(); const after=listAfter(board,e.clientX); if(after==null) board.appendChild(draggingList); else board.insertBefore(draggingList,after); });
    function listAfter(container,x){ const els=[...container.querySelectorAll('.list:not(.dragging)')]; return els.reduce((cl,ch)=>{ const r=ch.getBoundingClientRect(); const o=x-(r.left+r.width/2); return (o<0&&o>cl.offset)?{offset:o,element:ch}:cl },{offset:-Infinity,element:null}).element; }

    // ===== Listas =====
    function createList(title){ const list=el('section','list'); list.dataset.type='kanban'; list.draggable=false; const h=el('header'); const t=el('input','title'); t.value=title||'Nova lista'; const more=document.createElement('button'); more.className='more'; more.type='button'; more.textContent='⋯'; more.addEventListener('click',ev=>{ ev.stopPropagation(); const r=more.getBoundingClientRect(); showListCtx(r.right,r.bottom,list); }); h.append(t,more); list.appendChild(h); const cards=el('div','cards'); list.appendChild(cards); wireDropZone(cards);
      // entrada de novo cartão (sem botão Adicionar) com <form> para Android/"Ir"
      const add=el('div','add'); const form=el('form'); form.className='row'; form.setAttribute('autocomplete','off'); const input=el('input'); input.type='text'; input.placeholder='Novo cartão…'; input.setAttribute('enterkeyhint','go');
      function addCard(){ const v=(input.value||'').trim(); if(!v) return; const card=createCard({text:v}); cards.appendChild(card); input.value=''; persist(); }
      form.addEventListener('submit', (e)=>{ e.preventDefault(); addCard(); });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addCard(); }});
      input.addEventListener('keyup', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); }});
      form.append(input); add.append(form); list.append(add); board.appendChild(list);
      // mover listas: só pelo cabeçalho
      h.draggable=true; h.addEventListener('dragstart',(ev)=>{ draggingList=list; list.classList.add('dragging'); ev.dataTransfer?.setData('text/plain','list'); }); h.addEventListener('dragend',()=>{ draggingList=null; list.classList.remove('dragging'); persist(); });
      // menu de lista por clique direito no cabeçalho
      h.addEventListener('contextmenu',e=>{ e.preventDefault(); showListCtx(e.clientX,e.clientY,list); });
      return list; }

    // ===== Matriz =====
    function ensureMatrix(){ matrix.innerHTML=''; const corner=el('div','axis corner'); corner.style.gridColumn='1/2'; corner.style.gridRow='1/2'; matrix.appendChild(corner);
      const axX1=el('div','axis'); axX1.textContent='URGENTE'; axX1.style.gridColumn='2/3'; axX1.style.gridRow='1/2';
      const axX2=el('div','axis'); axX2.textContent='NÃO URGENTE'; axX2.style.gridColumn='3/4'; axX2.style.gridRow='1/2';
      const axY1=el('div','axis axis-y'); axY1.textContent='IMPORTANTE'; axY1.style.gridColumn='1/2'; axY1.style.gridRow='2/3';
      const axY2=el('div','axis axis-y'); axY2.textContent='NÃO IMPORTANTE'; axY2.style.gridColumn='1/2'; axY2.style.gridRow='3/4';
      matrix.append(axX1,axX2,axY1,axY2);
      const specs=[{quad:'Q1',label:'FAÇA AGORA',col:2,row:2},{quad:'Q2',label:'AGENDE',col:3,row:2},{quad:'Q3',label:'DELEGUE',col:2,row:3},{quad:'Q4',label:'ELIMINE',col:3,row:3}];
      specs.forEach(sp=>{ const l=el('section','list'); l.dataset.type='quad'; l.dataset.quad=sp.quad; const h=el('header'); const t=el('div','quad-label'); t.textContent=sp.label; h.append(t); const cs=el('div','cards'); wireDropZone(cs); l.append(h,cs); l.style.gridColumn=`${sp.col}/${sp.col+1}`; l.style.gridRow=`${sp.row}/${sp.row+1}`; matrix.appendChild(l); }); }

    // ===== Agenda =====
    function ensureSchedule(keepCards){ const keep={}; if(keepCards){ $$('.list[data-type="time"]',schedule).forEach(s=> keep[s.dataset.time]=[...s.querySelectorAll('.card')]); } slotsRoot.innerHTML=''; for(let h=5; h<=23; h++){ for(let m of [0,30]){ if(h===23&&m===30) break; const t=`${to2(h)}:${to2(m)}`; const slot=el('section','list slot'); slot.dataset.type='time'; slot.dataset.time=t; const head=el('div','head'); const label=el('span','time'); label.textContent=t; head.append(label); slot.append(head); const cards=el('div','cards'); slot.append(cards); wireDropZone(cards); slotsRoot.appendChild(slot); if(keep[t]) keep[t].forEach(n=> cards.appendChild(n)); }} schedule.addEventListener('dragover',e=>{ if(dragState){ e.preventDefault(); try{ e.dataTransfer.dropEffect='move'; }catch(_){ } } }, {passive:false}); updateSlotsHasItems(); const date=document.getElementById('agendaDate'); if(date&&!date.value){ date.value=new Date().toISOString().slice(0,10); } date?.addEventListener('change',()=>{ applyFilters(); updateSlotsHasItems(); });
      const copyBtn=document.getElementById('copyDay'); if(copyBtn && !copyBtn._wired){ copyBtn._wired=true; copyBtn.addEventListener('click',()=>{ showModal('Copiar agenda de…',()=>{ const wrap=document.createElement('div'); const i=document.createElement('input'); i.type='date'; i.style.width='100%'; wrap.appendChild(i); return wrap; },(wrap)=>{ const from=wrap.querySelector('input').value; if(!from) return; copyAgendaFrom(from, getActiveDay()); }); }); }
    }
    function copyAgendaFrom(fromDay,toDay){ if(fromDay===toDay) return; const cardsAll=$$('.card'); const toCopy=cardsAll.filter(c=> (c.dataset.when||'').startsWith(fromDay+'T'));
      toCopy.forEach(c=>{ const time=(c.dataset.when||'').slice(11,16); const dest=slotsRoot.querySelector(`.list[data-time="${time}"] .cards`); if(dest){ const clone=createCard(cardToData(c)); clone.dataset.when=`${toDay}T${time}`; dest.appendChild(clone); } }); updateSlotsHasItems(); persist(); }
    function updateSlotsHasItems(){ const day=getActiveDay(); $$('.list.slot',schedule).forEach(slot=>{ const time=slot.dataset.time; const cards=$$('.card',slot); let visible=0; cards.forEach(c=>{ const when=c.dataset.when||''; const ok=when.startsWith(day+'T')&&when.slice(11,16)===time && cardPassesFilters(c); c.style.display= ok? '' : 'none'; if(ok) visible++; }); slot.classList.toggle('has-items',visible>0); }); }

    // ===== Filtros =====
    function cardPassesFilters(c){
      const fFrom=document.getElementById('fFrom')?.value||'';
      const fTo=document.getElementById('fTo')?.value||'';
      let ok=true;
      if(selectedColors.size>0){ ok = ok && selectedColors.has((c.dataset.color||'').toLowerCase()); }
      if(fFrom){ ok= ok && (!!c.dataset.due && c.dataset.due>=fFrom); }
      if(fTo){ ok= ok && (!!c.dataset.due && c.dataset.due<=fTo); }
      return ok;
    }
    function applyFilters(){ $$('.card',board).forEach(c=> c.style.display= cardPassesFilters(c)? '' : 'none'); $$('.card',matrix).forEach(c=> c.style.display= cardPassesFilters(c)? '' : 'none'); updateSlotsHasItems(); }

    // ===== Context menu (cartão) =====
    let ctxTarget=null; const hideCtx=()=>{ ctx.style.display='none'; ctxTarget=null; ctxMoveSub.style.display='none'; ctxMoveAllSub.style.display='none'; };
    function showCtx(x,y,card){ ctxTarget=card; buildMoveSubmenu(); ctxMoveSub.style.display='none'; ctxMoveAllSub.style.display='none'; ctx.style.display='block'; const r=ctx.getBoundingClientRect(); ctx.style.left=Math.min(x,innerWidth-r.width-8)+'px'; ctx.style.top=Math.min(y,innerHeight-r.height-8)+'px'; }
    document.addEventListener('click',e=>{ if(!ctx.contains(e.target) && !listCtx.contains(e.target)) { hideCtx(); listCtx.style.display='none'; } });
    document.addEventListener('keydown',e=>{ if(e.key==='Delete'){ const block=getSelectionOr(); if(block.length){ block.forEach(n=>n.remove()); persist(); updateSlotsHasItems(); }} });
    function getActionBlock(){ const sel=getSelectionOr(ctxTarget); return sel; }
    function duplicateCards(cards){ if(!cards.length) return; const last=cards[cards.length-1]; const parent=last.parentElement; const after=last.nextSibling; cards.forEach(c=> parent.insertBefore(createCard(cardToData(c)),after)); persist(); }
    function buildMoveSubmenu(){ ctxMoveSub.innerHTML=''; $$('.list').forEach((l,i)=>{ const b=document.createElement('button'); const name=l.querySelector('.title')?.value || l.dataset.quad || l.dataset.time || `Lista ${i+1}`; b.textContent=name; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); const block=getActionBlock(); if(!block.length) return; const dest=(l.querySelector('.cards')||l); const isTime=l.dataset.type==='time'; const slotTime=l.dataset.time; const day=getActiveDay(); block.forEach(c=>{ dest.appendChild(c); if(isTime&&slotTime){ c.dataset.when=`${day}T${slotTime}`; } else { c.dataset.when=''; } }); if(isTime) l.classList.add('has-items'); persist(); applyFilters(); updateSlotsHasItems(); hideCtx(); }); ctxMoveSub.appendChild(b); }); }
    function buildMoveAllSubmenu(fromList){ ctxMoveAllSub.innerHTML=''; $$('.list').forEach((l,i)=>{ if(l===fromList) return; const b=document.createElement('button'); const name=l.querySelector('.title')?.value || l.dataset.quad || l.dataset.time || `Lista ${i+1}`; b.textContent=name; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); const src=fromList.querySelector('.cards'); const dest=(l.querySelector('.cards')||l); const isTime=l.dataset.type==='time'; const slotTime=l.dataset.time; const day=getActiveDay(); [...src.querySelectorAll('.card')].forEach(c=>{ dest.appendChild(c); if(isTime&&slotTime){ c.dataset.when=`${day}T${slotTime}`; } else { c.dataset.when=''; } }); if(isTime) l.classList.add('has-items'); persist(); applyFilters(); updateSlotsHasItems(); hideCtx(); }); ctxMoveAllSub.appendChild(b); }); }
    document.getElementById('ctx').addEventListener('click',e=>{ const btn=e.target.closest('button'); if(!btn) return; const action=btn.dataset.action; const block=getActionBlock();
      if(action==='move'){ ctxMoveSub.style.display = (ctxMoveSub.style.display==='block'?'none':'block'); ctxMoveAllSub.style.display='none'; return; }
      if(action==='move-all'){ const list = (ctxTarget||block[0])?.closest('.list'); if(!list) return; buildMoveAllSubmenu(list); ctxMoveAllSub.style.display = (ctxMoveAllSub.style.display==='block'?'none':'block'); ctxMoveSub.style.display='none'; return; }
      hideCtx();
      if(action==='dup'){ duplicateCards(block); }
      else if(action==='del'){ block.forEach(n=>n.remove()); persist(); updateSlotsHasItems(); }
      else if(action==='color'){ openColorDialog(block); }
      else if(action==='date'){ openDateDialog(block); }
      else if(action==='timer'){ const card=(block&&block[0])||ctxTarget; if(card) openTimerDialog(card); }
      else if(action==='del-all'){ const list=(ctxTarget||block[0])?.closest('.list'); if(!list) return; showConfirm('Excluir TODOS os cartões desta lista?',()=>{ $$('.card',list).forEach(c=>c.remove()); persist(); updateSlotsHasItems(); }); }
    });

    // ===== Contexto da lista =====
    let listCtxTarget=null;
    function showListCtx(x,y,list){ listCtxTarget=list; buildListMoveSub(); listMoveSub.style.display='none'; listCtx.style.display='block'; const r=listCtx.getBoundingClientRect(); listCtx.style.left=Math.min(x,innerWidth-r.width-8)+'px'; listCtx.style.top=Math.min(y,innerHeight-r.height-8)+'px'; }
    function buildListMoveSub(){ listMoveSub.innerHTML=''; if(!listCtxTarget) return; $$('.list').forEach((l,i)=>{ if(l===listCtxTarget) return; const b=document.createElement('button'); const name=l.querySelector('.title')?.value || l.dataset.quad || l.dataset.time || `Lista ${i+1}`; b.textContent=name; b.addEventListener('click',(ev)=>{ ev.stopPropagation(); const src=listCtxTarget.querySelector('.cards'); const dest=(l.querySelector('.cards')||l); const isTime=l.dataset.type==='time'; const time=l.dataset.time; const day=getActiveDay(); [...src.querySelectorAll('.card')].forEach(c=>{ dest.appendChild(c); if(isTime&&time){ c.dataset.when=`${day}T${time}`; } else { c.dataset.when=''; } }); if(isTime) l.classList.add('has-items'); persist(); applyFilters(); updateSlotsHasItems(); listMoveSub.style.display='none'; listCtx.style.display='none'; }); listMoveSub.appendChild(b); }); }
    listCtx.addEventListener('click',e=>{ const b=e.target.closest('button'); if(!b) return; const action=b.dataset.action; if(action==='list-move-all'){ listMoveSub.style.display = (listMoveSub.style.display==='block'?'none':'block'); return; } if(action==='list-del' && listCtxTarget){ showConfirm('Excluir a lista inteira?',()=>{ listCtxTarget.remove(); persist(); }); } listCtx.style.display='none'; });

    // ===== Modal helpers =====
    function showModal(title,builder,onOk){ const wrap=document.createElement('div'); wrap.className='modal-wrap'; const box=document.createElement('div'); box.className='modal'; const h=document.createElement('h3'); h.textContent=title; box.appendChild(h); const body=builder(); box.appendChild(body); const row=document.createElement('div'); row.className='row'; const ok=document.createElement('button'); ok.textContent='OK'; const cancel=document.createElement('button'); cancel.textContent='Cancelar'; cancel.style.background='#6b7a93'; row.append(cancel,ok); box.appendChild(row); wrap.appendChild(box); document.body.appendChild(wrap); cancel.onclick=()=>document.body.removeChild(wrap); ok.onclick=()=>{ onOk(body); document.body.removeChild(wrap); applyFilters(); persist(); }; }
    function showConfirm(message,onYes){ showModal('Confirmação', ()=>{ const d=document.createElement('div'); d.textContent=message; return d; }, ()=>{ if(typeof onYes==='function') onYes(); }); }
    function openColorDialog(cards){ if(!cards.length) return; const PALETTE=[{id:'none',name:'Sem cor',hex:''},{id:'q1',name:'Verde (Faça agora)',hex:'#104239'},{id:'q2',name:'Azul (Agende)',hex:'#0e3155'},{id:'q3',name:'Âmbar (Delegue)',hex:'#5a4014'},{id:'q4',name:'Vermelho (Elimine)',hex:'#5a1419'},{id:'gray',name:'Cinza',hex:'#39424e'},{id:'purple',name:'Roxo',hex:'#3a1f5a'}]; showModal('Editar cor',()=>{ const wrap=document.createElement('div'); wrap.style.display='grid';wrap.style.gridTemplateColumns='repeat(3, minmax(0,1fr))';wrap.style.gap='8px'; PALETTE.forEach(p=>{ const b=document.createElement('button'); b.type='button'; b.style.border='1px solid #2a4e78'; b.style.borderRadius='8px'; b.style.padding='10px'; b.style.cursor='pointer'; b.style.background=p.hex||'#0b2240'; b.style.color='#fff'; b.textContent=p.name; b.addEventListener('click',()=>{ wrap.querySelectorAll('button').forEach(x=>x.dataset.sel=''); b.dataset.sel='1'; wrap._chosen=p.hex; }); if(p.hex===(cards[0].dataset.color||'')) b.dataset.sel='1'; wrap.appendChild(b); }); return wrap; }, (wrap)=>{ const v=wrap._chosen===undefined? (cards[0].dataset.color||'') : wrap._chosen; cards.forEach(c=>{ c.dataset.color=v||''; paintCard(c); }); }); }
    function openDateDialog(cards){ if(!cards.length) return; showModal('Editar data',()=>{ const r=document.createElement('div'); const i=document.createElement('input'); i.type='date'; if(cards[0].dataset.due) i.value=cards[0].dataset.due; r.appendChild(i); return r; },(r)=>{ const v=r.querySelector('input').value; cards.forEach(c=>{ c.dataset.due=v||''; paintCard(c); }); }); }

    // ===== Timer =====
    function updateTimerBadge(card){
      let badge=card.querySelector('.timer'); if(!badge){ badge=document.createElement('span'); badge.className='timer'; badge.title='Duplo clique: iniciar/pausar'; card.querySelector('.meta').appendChild(badge); }
      if(!badge._wired){ badge._wired=true; badge.addEventListener('dblclick',()=>{ toggleTimer(card); }); }
      const endIso=card.dataset.timerEnd||''; const leftStr=card.dataset.timerLeft||'';
      if(endIso){ const now=Date.now(); const ms=Math.max(0, Date.parse(endIso)-now); const totalSec=Math.floor(ms/1000); const mm=Math.floor(totalSec/60); const ss=totalSec%60; badge.textContent=`⏱ ${mm}:${String(ss).padStart(2,'0')}`; badge.classList.toggle('danger', totalSec<=10); badge.classList.toggle('warn', totalSec>10 && totalSec<=60); }
      else if(leftStr){ const totalSec=Math.max(0, parseInt(leftStr,10)||0); const mm=Math.floor(totalSec/60); const ss=totalSec%60; badge.textContent=`⏸ ${mm}:${String(ss).padStart(2,'0')}`; badge.classList.remove('danger'); badge.classList.remove('warn'); }
      else { badge.textContent=''; badge.classList.remove('danger'); badge.classList.remove('warn'); }
      updateTotalTimer();
    }

    function toggleTimer(card){ const now=Date.now(); if(card.dataset.timerEnd){ const left=Math.max(0, Math.floor((Date.parse(card.dataset.timerEnd)-now)/1000)); delete card.dataset.timerEnd; card.dataset.timerLeft=String(left); updateTimerBadge(card); persist(); return; } let left=parseInt(card.dataset.timerLeft||''); if(!left || isNaN(left)){ return; } delete card.dataset.timerMoved; card.dataset.timerEnd=new Date(now + left*1000).toISOString(); delete card.dataset.timerLeft; updateTimerBadge(card); persist(); startGlobalTimer(); }

    let __timerTick=null; function startGlobalTimer(){ if(__timerTick) return; __timerTick = setInterval(function(){ var now = Date.now(); var active=0; $$('.card').forEach(function(c){ var endIso=c.dataset.timerEnd; if(endIso){ active++; var end=Date.parse(endIso); var remaining=end-now; if(remaining<=0){ if(c.dataset.timerMoved!=='1'){ c.dataset.timerMoved='1'; delete c.dataset.timerEnd; delete c.dataset.timerLeft; c.dataset.color='#5a1419'; paintCard(c); var q1=matrix.querySelector('.list[data-type="quad"][data-quad="Q1"] .cards'); if(q1) q1.appendChild(c); persist(); var name=(c.querySelector('.text')&&c.querySelector('.text').textContent||'Cartão').trim(); notify(name+': tempo esgotado'); } } } updateTimerBadge(c); }); if(active===0){ clearInterval(__timerTick); __timerTick=null; } }, 1000); }

    function openTimerDialog(card){ showModal('Timer do cartão', function(){ var wrap=document.createElement('div'); var display=document.createElement('div'); display.style.fontSize='22px'; display.style.fontWeight='700'; display.style.textAlign='center'; display.style.margin='8px 0'; var row=document.createElement('div'); row.style.display='flex'; row.style.gap='6px'; row.style.flexWrap='wrap'; var quick=[60, 3*60, 5*60, 10*60, 60*60]; function fmt(s){ var m=Math.floor(s/60), ss=s%60; return m+':' + String(ss).padStart(2,'0'); } function setSec(sec){ if(sec<0) sec=0; wrap._sec=sec; display.textContent=fmt(sec); }
        quick.forEach(function(s){ var b=document.createElement('button'); b.textContent=fmt(s); b.type='button'; b.onclick=function(){ setSec(s); }; row.appendChild(b); });
        var plus1=document.createElement('button'); plus1.textContent='+1m'; plus1.onclick=function(){ setSec((wrap._sec||60)+60); };
        var minus1=document.createElement('button'); minus1.textContent='-1m'; minus1.onclick=function(){ setSec(Math.max(0,(wrap._sec||60)-60)); };
        var plus3=document.createElement('button'); plus3.textContent='+3m'; plus3.onclick=function(){ setSec((wrap._sec||60)+180); };
        var minus3=document.createElement('button'); minus3.textContent='-3m'; minus3.onclick=function(){ setSec(Math.max(0,(wrap._sec||60)-180)); };
        var plus5=document.createElement('button'); plus5.textContent='+5m'; plus5.onclick=function(){ setSec((wrap._sec||60)+300); };
        var minus5=document.createElement('button'); minus5.textContent='-5m'; minus5.onclick=function(){ setSec(Math.max(0,(wrap._sec||60)-300)); };
        var plus10=document.createElement('button'); plus10.textContent='+10m'; plus10.onclick=function(){ setSec((wrap._sec||60)+600); };
        var minus10=document.createElement('button'); minus10.textContent='-10m'; minus10.onclick=function(){ setSec(Math.max(0,(wrap._sec||60)-600)); };
        var plus60=document.createElement('button'); plus60.textContent='+60m'; plus60.onclick=function(){ setSec((wrap._sec||60)+3600); };
        var minus60=document.createElement('button'); minus60.textContent='-60m'; minus60.onclick=function(){ setSec(Math.max(0,(wrap._sec||60)-3600)); };
        wrap.append(display,row,plus1,minus1,plus3,minus3,plus5,minus5,plus10,minus10,plus60,minus60); setSec(60); return wrap; }, function(wrap){ var sec=wrap._sec||60; delete card.dataset.timerEnd; card.dataset.timerLeft=String(sec); updateTimerBadge(card); }); }

    function updateTotalTimer(){ var sum=0; $$('.card').forEach(function(c){ if(c.dataset.timerEnd){ var left=Math.max(0, Math.floor((Date.parse(c.dataset.timerEnd)-Date.now())/1000)); sum+=left; } else if(c.dataset.timerLeft){ sum+=parseInt(c.dataset.timerLeft,10)||0; } }); var mm=Math.floor(sum/60), ss=sum%60; var elSum=document.getElementById('sumTimers'); if(elSum) elSum.textContent= mm+':'+String(ss).padStart(2,'0'); }

    function notify(msg){ try{ var Ctx=(window.AudioContext||window.webkitAudioContext); var ctxA=new Ctx(); var o=ctxA.createOscillator(); var g=ctxA.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0008; o.connect(g); g.connect(ctxA.destination); o.start(); setTimeout(function(){ o.stop(); ctxA.close(); }, 180); }catch(e){} showModal('Aviso', function(){ var d=document.createElement('div'); d.textContent=msg; return d; }, function(){}); }

    function openColorFilters(){ var PALETTE=[{name:'Todas', hex:'*'},{name:'Sem cor', hex:''},{name:'Verde (Faça agora)',hex:'#104239'},{name:'Azul (Agende)',hex:'#0e3155'},{name:'Âmbar (Delegue)',hex:'#5a4014'},{name:'Vermelho (Elimine)',hex:'#5a1419'},{name:'Cinza',hex:'#39424e'},{name:'Roxo',hex:'#3a1f5a'}]; showModal('Filtrar por cor', function(){ var wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gridTemplateColumns='repeat(3,minmax(0,1fr))'; wrap.style.gap='8px'; PALETTE.forEach(function(p){ var b=document.createElement('button'); b.type='button'; b.textContent=p.name; b.dataset.hex=p.hex; b.style.padding='10px'; b.style.borderRadius='8px'; b.style.border='1px solid #2a4e78'; b.style.background=(p.hex&&p.hex!=='*'?p.hex:'#0b2240'); b.style.color='#fff'; b.onclick=function(){ if(p.hex==='*'){ wrap._all=true; wrap.querySelectorAll('button').forEach(function(x){x.dataset.sel='';}); b.dataset.sel='1'; return; } delete wrap._all; b.dataset.sel=b.dataset.sel?'':'1'; }; wrap.appendChild(b); }); return wrap; }, function(wrap){ selectedColors.clear(); if(wrap._all){ /* todas */ } else { wrap.querySelectorAll('button[data-sel="1"]').forEach(function(btn){ var hex=btn.dataset.hex||''; selectedColors.add(hex); }); } applyFilters(); }); }

    function initDemo(){ ensureMatrix(); ensureSchedule(); createList('A Fazer'); createList('Fazendo'); createList('Feito'); }

    on('undo','click',doUndo); on('redo','click',doRedo);
    on('addList','click',function(){ createList('Nova lista'); persist(); });
    on('reset','click',function(){ localStorage.removeItem(LS_KEY); hist=[]; cursor=-1; initDemo(); pushHistory(serialize()); });
    on('androidToggle','click',function(){ document.body.classList.toggle('android'); });
    on('filterColorsBtn','click',openColorFilters);
    on('clearFilters','click',function(){ selectedColors.clear(); var ff=document.getElementById('fFrom'); var ft=document.getElementById('fTo'); if(ff) ff.value=''; if(ft) ft.value=''; applyFilters(); });

    document.addEventListener('keydown',function(e){ var k=(e.key||'').toLowerCase(); if((e.ctrlKey||e.metaKey) && !e.shiftKey && k==='z'){ e.preventDefault(); doUndo(); } if((e.ctrlKey||e.metaKey) && e.shiftKey && k==='z'){ e.preventDefault(); doRedo(); } });

    // ====== NOVO: Exportar / Importar JSON ======
    function pad2(n){return (n<10?'0':'')+n}
    function ts(){ const d=new Date(); return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}` }
    function download(filename, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); }
    function doExport(){ const payload={ version:1, exportedAt:new Date().toISOString(), data: serialize() }; download(`mini-trello-backup-${ts()}.json`, JSON.stringify(payload)); }

    function doImportFromText(txt){ let parsed=null; try{ parsed=JSON.parse(txt); }catch(e){ alert('Arquivo inválido (JSON)'); return; }
      const arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.data)? parsed.data : null);
      if(!arr){ alert('Estrutura não reconhecida. Esperado um array de listas ou objeto {data:[...]}.'); return; }
      showConfirm('Importar vai substituir o conteúdo atual. Deseja continuar?', ()=>{
        withMute(()=>{ restore(arr); pushHistory(arr); try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }catch(e){} });
        notify('Importado com sucesso.');
      });
    }

    on('exportJson','click', doExport);
    on('importJsonBtn','click', ()=>{ const inp=document.getElementById('importFile'); if(!inp) return; inp.value=''; inp.click(); });
    const fileInput=document.getElementById('importFile');
    if(fileInput && !fileInput._wired){ fileInput._wired=true; fileInput.addEventListener('change',()=>{ const f=fileInput.files && fileInput.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ doImportFromText(String(reader.result||'')); }; reader.readAsText(f); }); }

    // ===== start =====
    load();
  })();
  </script>
</body>
</html>
