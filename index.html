
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Mini Trello â€” Kanban + Matriz + Agenda (Sync Hotfix)</title>
</head>
<body>
  <header class="app">
    <h1>Mini Trello (Sync Hotfix)</h1>
    <button id="reset">Resetar</button>
    <button id="wipeRoom" class="ghost" title="Apagar dados desta sala no servidor">Limpar sala</button>
  </header>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvRlr_fkqDkKVxBFAScjRuumdTs-LCJPs",
      authDomain: "teaplanner0.firebaseapp.com",
      databaseURL: "https://teaplanner0-default-rtdb.firebaseio.com",
      projectId: "teaplanner0",
      storageBucket: "teaplanner0.firebasestorage.app",
      messagingSenderId: "228994472713",
      appId: "1:228994472713:web:193ab46362c41473e1d1d8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const room = (location.hash||"").replace(/^#/, "") || "geral";
    const node = ref(db, "boards/" + encodeURIComponent(room));

    let lastRemoteTs = 0;
    let applyingRemote = false;
    let firstLoadDone = false;

    // wipe room button
    const wipeBtn = document.getElementById("wipeRoom");
    if (wipeBtn) {
      wipeBtn.addEventListener("click", async () => {
        try {
          await remove(node);
          try { localStorage.removeItem("mini-trello-restore"); } catch(_) {}
          location.reload();
        } catch (e) {
          alert("Falha ao limpar sala: " + (e?.message || e));
        }
      });
    }

    await new Promise((resolve, reject) => {
      onAuthStateChanged(auth, (user) => {
        if (user) resolve();
        else signInAnonymously(auth).catch(reject);
      });
    });

    function serialize() {
      try {
        return JSON.parse(localStorage.getItem("mini-trello-restore")||"[]");
      } catch(_) { return []; }
    }
    function restore(arr) {
      localStorage.setItem("mini-trello-restore", JSON.stringify(arr));
    }

    window.__sync = {
      publish(snap){
        if (applyingRemote) return;
        try {
          const ts = Date.now();
          lastRemoteTs = Math.max(lastRemoteTs, ts);
          set(node, { data: snap, updatedAt: ts });
        } catch (e) {
          console.warn("Falha ao publicar no Firebase:", e);
        }
      }
    };

    onValue(node, (snap) => {
      const val = snap.val();
      const remote = val?.data;
      const rTs = Number(val?.updatedAt || 0);
      if (rTs && rTs <= lastRemoteTs) { return; }
      if (rTs) lastRemoteTs = rTs;
      if (!firstLoadDone) {
        firstLoadDone = true;
        if (!remote || !Array.isArray(remote) || remote.length === 0) {
          try {
            const local = serialize();
            const ts = Date.now();
            lastRemoteTs = Math.max(lastRemoteTs, ts);
            set(node, { data: local, updatedAt: ts });
          } catch (e) { console.warn(e); }
          return;
        }
      }
      if (remote && Array.isArray(remote)) {
        applyingRemote = true;
        try {
          restore(remote);
        } finally {
          applyingRemote = false;
        }
      }
    });

    // Test UI
    document.getElementById("reset").addEventListener("click", () => {
      const snap = [];
      restore(snap);
      window.__sync.publish(snap);
    });
  </script>
</body>
</html>
