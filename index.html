<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>Mini Trello — Sync FAST (com Undo/Redo)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%231976d2'/%3E%3Cpath d='M30 70h68v14H30zM30 44h40v14H30z' fill='%23fff'/%3E%3C/svg%3E" />
  <style>
    :root{--bg:#0f1a2a;--panel:#0f223d;--ink:#e9f1ff;--brand:#1976d2;--card:#112b4a;--muted:#9fb3d2}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
    header.app{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--brand);color:#fff;flex-wrap:wrap}
    header.app h1{margin:0;font-size:18px;font-weight:700}
    header.app .right{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    header.app button{border:none;border-radius:8px;padding:6px 10px;cursor:pointer;background:#0e58a5;color:#fff}
    header.app button.ghost{background:#0b437e}
    .workspace{display:grid;grid-template-columns:1fr 240px;gap:12px;padding:12px;align-items:start;contain:paint}
    .left{display:flex;flex-direction:column;gap:12px;min-width:0}
    .board{display:flex;gap:12px;align-items:flex-start;overflow:auto}
    .list{background:var(--panel);border:1px solid #183453;border-radius:10px;display:flex;flex-direction:column;min-width:240px}
    .list header{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #19375b;background:#122b4a}
    .list header input.title{flex:1;border:none;border-radius:8px;padding:6px 8px;background:#0e2542;color:var(--ink)}
    .cards{display:flex;flex-direction:column;gap:6px;padding:8px;min-height:34px}
    .card{background:var(--card);border:1px solid #20486f;border-left:6px solid transparent;border-radius:8px;padding:8px;user-select:none}
    .card .text{white-space:pre-wrap}
    .meta{margin-top:6px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #375b86}
    .add{padding:8px;border-top:1px solid #19375b}
    .add .row{display:flex;gap:6px}
    .add input[type=text]{flex:1;border:1px solid #2a4e78;border-radius:8px;padding:8px;background:#0b2240;color:var(--ink)}
    .matrix{display:grid;grid-template-columns:40px 1fr 1fr;grid-template-rows:40px auto auto;gap:12px;align-items:start}
    .axis{display:flex;align-items:center;justify-content:center;font-weight:700;color:#cfe0ff;background:#102b4f;border:1px solid #1a416a;border-radius:10px}
    .axis.corner{background:transparent;border:none}
    .axis.axis-y{writing-mode:vertical-rl;transform:rotate(180deg);display:flex;align-items:center;justify-content:center;padding:4px 0;font-weight:700;color:#cfe0ff;background:#102b4f;border:1px solid #1a416a;border-radius:10px}
    .quad-label{font-weight:700;color:#cfe0ff}
    .list[data-type="quad"]{min-width:unset}
    .list[data-type="quad"][data-quad="Q1"] header{background:#104239}
    .list[data-type="quad"][data-quad="Q2"] header{background:#0e3155}
    .list[data-type="quad"][data-quad="Q3"] header{background:#5a4014}
    .list[data-type="quad"][data-quad="Q4"] header{background:#5a1419}
    .schedule{background:var(--panel);border:1px solid #183453;border-radius:12px;max-height:calc(100vh - 84px);overflow:auto;position:sticky;top:84px;min-width:240px;width:240px;contain:content}
    .schedule header{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#0b437e;color:#fff;border-top-left-radius:12px;border-top-right-radius:12px;z-index:2}
    .schedule header input[type=date]{background:#0b2240;color:#fff;border:1px solid #2a4e78;border-radius:8px;padding:6px 8px}
    .slot{border-bottom:1px dashed #244b78}
    .slot>div.head{display:flex;align-items:center;gap:6px;padding:0 4px}
    .slot .time{font-weight:700;font-size:11px;color:#9fc1ff}
    .slot .cards{display:none;padding:4px;min-height:28px}
    .slot.has-items .cards{display:block}
    .modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#0b1220;color:#fff;border:1px solid #24314a;border-radius:12px;min-width:280px;max-width:94vw;padding:14px 14px 10px}
    .modal h3{margin:0 0 10px;font-size:16px}
    .modal .row{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
    .modal .row button{background:#1976d2;border:none;border-radius:8px;color:#fff;padding:8px 10px;cursor:pointer}
    .modal .row button:nth-child(1){background:#6b7a93}
    @media (max-width: 900px) {.workspace{grid-template-columns:1fr 220px}.list{min-width:220px}.schedule{width:220px;min-width:220px}.modal{max-width:96vw}}
  </style>
</head>
<body>
  <header class="app">
    <h1>Mini Trello</h1>
    <div class="right">
      <button id="androidToggle" class="ghost">Modo Android</button>
      <button id="addList">+ Lista</button>
      <button id="undoBtn" class="ghost" title="Desfazer (Ctrl+Z)">↶ Undo</button>
      <button id="redoBtn" class="ghost" title="Refazer (Ctrl+Y)">↷ Redo</button>
      <button id="exportJson" class="ghost">Exportar JSON</button>
      <button id="importJsonBtn" class="ghost">Importar JSON</button>
      <input id="importFile" type="file" accept="*/*" style="display:none" />
      <button id="btnDedupe" class="ghost" title="Remove cartões duplicados">Limpar Duplicados</button>
      <button id="reset">Resetar</button>
    </div>
  </header>
  <section class="workspace">
    <div class="left">
      <main class="board" id="board"></main>
      <section class="matrix" id="matrix"></section>
    </div>
    <aside class="schedule" id="schedule">
      <header><strong>AGENDA</strong><div style="display:flex;align-items:center;gap:8px"><input id="agendaDate" type="date" /></div></header>
      <div id="slots"></div>
    </aside>
  </section>
  <script>
  (function(){
    const el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n};
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const to2=n=> (n<10?'0'+n:''+n);
    const LS_KEY='mini-trello-restore';
    const board=document.getElementById('board');
    const matrix=document.getElementById('matrix');
    const slotsRoot=document.getElementById('slots');

    const undoStack=[], redoStack=[];
    function pushSnapshot(){ try{ undoStack.push(JSON.stringify({data:serialize()})); redoStack.length=0; }catch(e){} setUndoRedoState(); }
    function setUndoRedoState(){ undoBtn.disabled=undoStack.length===0; redoBtn.disabled=redoStack.length===0; }
    function applySnapshot(jsonStr){ try{ const obj=JSON.parse(jsonStr); const arr = Array.isArray(obj)?obj:(Array.isArray(obj.data)?obj.data:obj); if(Array.isArray(arr)) restoreAll(arr);}catch(e){} }
    function undo(){ if(!undoStack.length) return; const current = JSON.stringify({data:serialize()}); const prev = undoStack.pop(); redoStack.push(current); applySnapshot(prev); setUndoRedoState(); }
    function redo(){ if(!redoStack.length) return; const current = JSON.stringify({data:serialize()}); const next = redoStack.pop(); undoStack.push(current); applySnapshot(next); setUndoRedoState(); }
    window.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); } if((e.ctrlKey||e.metaKey) && (e.key.toLowerCase()==='y'||(e.shiftKey&&e.key.toLowerCase()==='z'))){ e.preventDefault(); redo(); } });

    let __persistTick=null;
    const __idle=window.requestIdleCallback||function(cb){return setTimeout(()=>cb({timeRemaining:()=>1}),1)};
    function persist(){ clearTimeout(__persistTick); __persistTick=setTimeout(()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(serialize())); }catch(e){} }, 180); }

    function cardToData(c){return{ text:(c.querySelector('.text')?.textContent||'').trim(), color:c.dataset.color||'', due:c.dataset.due||'', when:c.dataset.when||'' }}
    function serialize(){ const data=[];
      $$('.list[data-type="kanban"]',board).forEach(l=> data.push({type:'kanban',title:l.querySelector('.title').value,cards:$$('.card',l).map(cardToData)}));
      $$('.list[data-type="quad"]',matrix).forEach(l=> data.push({type:'quad',quad:l.dataset.quad,cards:$$('.card',l).map(cardToData)}));
      $$('.list[data-type="time"]').forEach(s=> data.push({type:'time',time:s.dataset.time,cards:$$('.card',s).map(cardToData)}));
      return data; }

    function paintCard(c){ const color=c.dataset.color||''; if(color){ c.style.background=color; c.style.borderColor=color; c.style.borderLeftColor=color; } else { c.style.background=getComputedStyle(document.documentElement).getPropertyValue('--card')||'#112b4a'; c.style.borderColor='#20486f'; c.style.borderLeftColor='transparent'; } }
    function createCard(data){ const {text,color,due,when}=typeof data==='string'?{text:data}:data||{text:''}; const c=el('div','card'); c.draggable=true; c.dataset.color=color||''; c.dataset.due=due||''; if(when) c.dataset.when=when; const t=el('span','text'); t.textContent=text||''; const meta=el('div','meta'); const dot=el('span','dot'); meta.append(dot); c.append(t,meta); paintCard(c); return c; }
    function createList(title){ const list=el('section','list'); list.dataset.type='kanban'; const h=el('header'); const t=el('input','title'); t.value=title||'Nova lista'; h.append(t); const cards=el('div','cards'); list.append(h,cards); const add=el('div','add'); const form=el('form'); form.className='row'; const input=el('input'); input.type='text'; input.placeholder='Novo cartão…'; input.setAttribute('enterkeyhint','go'); function addCard(){ const v=(input.value||'').trim(); if(!v) return; cards.appendChild(createCard({text:v})); input.value=''; persist(); pushSnapshot(); } form.addEventListener('submit',e=>{e.preventDefault(); addCard();}); input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addCard(); }}); form.append(input); add.append(form); list.append(add); board.appendChild(list); return list; }

    function ensureMatrix(){ matrix.innerHTML=''; const corner=el('div','axis corner'); corner.style.gridColumn='1/2'; corner.style.gridRow='1/2'; matrix.appendChild(corner);
      const axX1=el('div','axis'); axX1.textContent='URGENTE'; axX1.style.gridColumn='2/3'; axX1.style.gridRow='1/2';
      const axX2=el('div','axis'); axX2.textContent='NÃO URGENTE'; axX2.style.gridColumn='3/4'; axX2.style.gridRow='1/2';
      const axY1=el('div','axis axis-y'); axY1.textContent='IMPORTANTE'; axY1.style.gridColumn='1/2'; axY1.style.gridRow='2/3';
      const axY2=el('div','axis axis-y'); axY2.textContent='NÃO IMPORTANTE'; axY2.style.gridColumn='1/2'; axY2.style.gridRow='3/4';
      matrix.append(axX1,axX2,axY1,axY2);
      const specs=[{quad:'Q1',label:'FAÇA AGORA',col:2,row:2},{quad:'Q2',label:'AGENDE',col:3,row:2},{quad:'Q3',label:'DELEGUE',col:2,row:3},{quad:'Q4',label:'ELIMINE',col:3,row:3}];
      specs.forEach(sp=>{ const l=el('section','list'); l.dataset.type='quad'; l.dataset.quad=sp.quad; const h=el('header'); const t=el('div','quad-label'); t.textContent=sp.label; h.append(t); const cs=el('div','cards'); l.append(h,cs); l.style.gridColumn=`${sp.col}/${sp.col+1}`; l.style.gridRow=`${sp.row}/${sp.row+1}`; matrix.appendChild(l); });
    }

    function ensureSchedule(){ slotsRoot.innerHTML=''; for(let h=5; h<=23; h++){ for(let m of [0,30]){ if(h===23 && m===30) break; const t=`${to2(h)}:${to2(m)}`; const slot=el('section','list slot'); slot.dataset.type='time'; slot.dataset.time=t; const head=el('div','head'); const label=el('span','time'); label.textContent=t; head.append(label); slot.append(head); const cards=el('div','cards'); slot.append(cards); slotsRoot.appendChild(slot); } } }

    function cleanDuplicates(filterText){ const makeKey=(card, owner)=>{ const text=(card.querySelector('.text')?.textContent||'').trim(); const due=card.dataset.due||''; const when=card.dataset.when||''; const color=(card.dataset.color||'').toLowerCase(); const scope= owner.dataset.type+':'+(owner.dataset.quad||owner.dataset.time||owner.querySelector('.title')?.value||''); return scope+'|'+text+'|'+due+'|'+when+'|'+color; }; const seen=new Set(); let removed=0; $$('.list').forEach(list=>{ const cards=$$('.card',list); cards.forEach(c=>{ const text=(c.querySelector('.text')?.textContent||'').trim(); if(filterText && text.toLowerCase()!==filterText.toLowerCase()) return; const k=makeKey(c, list); if(seen.has(k)){ c.remove(); removed++; } else { seen.add(k); } }); }); if(removed>0){ persist(); pushSnapshot(); } return removed; }

    function restoreAll(arr){ board.innerHTML=''; ensureMatrix(); ensureSchedule(); const hasKanban = arr.some(x=>x.type==='kanban'); if(!hasKanban){ createList('A Fazer'); createList('Fazendo'); createList('Feito'); } arr.forEach(x=>{ if(x.type==='kanban'){ let list=[...$$('.list[data-type="kanban"]',board)].find(l=> l.querySelector('.title').value===x.title); if(!list){ list=createList(x.title); } const cont=list.querySelector('.cards'); (x.cards||[]).forEach(cd=> cont.appendChild(createCard(cd))); } else if(x.type==='quad'){ const cont=matrix.querySelector(`.list[data-quad="${x.quad}"] .cards`); (x.cards||[]).forEach(cd=> cont.appendChild(createCard(cd))); } else if(x.type==='time'){ const cont=document.querySelector(`.list[data-time="${x.time}"] .cards`); if(!cont) return; (x.cards||[]).forEach(cd=> cont.appendChild(createCard(cd))); if((x.cards||[]).length) cont.parentElement.classList.add('has-items'); } }); cleanDuplicates(); persist(); }

    function confirmCentered(msg, onYes){ const wrap=document.createElement('div'); wrap.className='modal-wrap'; const box=document.createElement('div'); box.className='modal'; const h=document.createElement('h3'); h.textContent='Confirmação'; box.appendChild(h); const p=document.createElement('div'); p.textContent=msg; box.appendChild(p); const row=document.createElement('div'); row.className='row'; const cancel=document.createElement('button'); cancel.textContent='Cancelar'; const ok=document.createElement('button'); ok.textContent='OK'; row.append(cancel,ok); box.appendChild(row); wrap.appendChild(box); document.body.appendChild(wrap); cancel.onclick=()=> document.body.removeChild(wrap); ok.onclick=()=>{ document.body.removeChild(wrap); onYes&&onYes(); }; }

    function pad2(n){return (n<10?'0':'')+n} function ts(){ const d=new Date(); return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}` } function download(filename, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0); } function doExport(){ const payload={ version:1, exportedAt:new Date().toISOString(), data: serialize() }; download(`mini-trello-backup-${ts()}.json`, JSON.stringify(payload)); }
    function doImportFromText(txt){ let parsed=null; try{ parsed=JSON.parse(txt); }catch(e){ alert('Arquivo inválido (JSON)'); return; } const arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.data)? parsed.data : null); if(!arr){ alert('Estrutura não reconhecida.'); return; } confirmCentered('Importar vai substituir o conteúdo atual. Deseja continuar?', ()=>{ restoreAll(arr); try{ localStorage.setItem(LS_KEY, JSON.stringify({data:arr})); }catch(e){} pushSnapshot(); }); }

    function load(){ ensureMatrix(); ensureSchedule(); createList('A Fazer'); createList('Fazendo'); createList('Feito'); const date=document.getElementById('agendaDate'); if(date&&!date.value){ date.value=new Date().toISOString().slice(0,10); } let raw=null; try{ raw=localStorage.getItem(LS_KEY);}catch(e){} if(raw){ try{ const data=JSON.parse(raw); const arr=Array.isArray(data)?data:(data&&Array.isArray(data.data)?data.data:[]); if(arr&&arr.length){ restoreAll(arr); } }catch(e){} } const n=cleanDuplicates('Participa'); if(n>0) console.log('Duplicados removidos:', n); pushSnapshot(); setUndoRedoState(); }

    addList.onclick=()=>{ createList('Nova lista'); persist(); pushSnapshot(); };
    reset.onclick=()=>{ confirmCentered('Zerar tudo?', ()=>{ localStorage.removeItem(LS_KEY); location.reload(); }); };
    androidToggle.onclick=()=>{ document.body.classList.toggle('android'); };
    exportJson.onclick=doExport;
    importJsonBtn.onclick=()=>{ importFile.value=null; importFile.click(); };
    importFile.onchange=()=>{ const f=importFile.files&&importFile.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> doImportFromText(String(r.result||'')); r.readAsText(f); importFile.value=null; };
    btnDedupe.onclick=()=>{ const n=cleanDuplicates(); alert(n?`Removidos ${n} cartões duplicados.`:'Nenhum duplicado encontrado.'); };
    undoBtn.onclick=undo; redoBtn.onclick=redo;

    load();
  })();
  </script>
</body>
</html>
